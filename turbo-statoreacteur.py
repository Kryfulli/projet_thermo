import numpy as np
import matplotlib.pyplot as plt
import csv
import random

#variables
#Tt4=1600

gamma=1.4
#cp=1004 #cp massique
#PCI=42.8*(10**6)
Patm=1.0
g=9.81
r=287.0
R=8.314
Tb=2000.0
T_H2_0=20.0


#Valeurs numériques
M_H2=2*0.001
M_O2=32*0.001
M_N2=28.0*0.001
M_air=0.21*M_O2+0.79*M_N2
M_H2O=M_O2/2.0+M_H2
Zst=2.38

#flux echangeur de chaleur
flux_1_5=0.0 #W
flux_3_4=0.0#W


#conditions nominales
Dn=180.0
Tn=288.0
Pn=1.0
PIn=6.67

#definition des listes
P=[]
T=[]
Pt=[]
Tt=[]

#CRS-CFR
cr = csv.reader(open("CRS-CFR.csv","rb"))
CFR1=[]
CRS=[]
for row in cr:
    CFR1.append(float(row[0][0:15]))
    CRS.append(float(row[0][18:32]))


#RPR-CFR tous les valeurs qui sont des pourcentages sont multiplies par 100
cr = csv.reader(open("RPR-CFR.csv","rb"))
RPR=[]
CFR2=[]
for row in cr:
    CFR2.append(float(row[0][0:15]))
    RPR.append(float(row[0][18:32]))


def cp_air(T) :
    if T<1000.0 :
        a_N2=[0.02926640E+02,0.14879768E-02,-0.05684760E-05,0.10097038E-09,-0.06753351E-13,-0.09227977E+04,0.05980528E+02]
        a_O2=[3.28253784E+00,1.48308754E-03,-7.57966669E-07,2.09470555E-10,-2.16717794E-14,-1.08845772E+03,5.45323129E+00]
        Cp_N2 = R*(a_N2[0] + a_N2[1]*T + a_N2[2]*(T**2.0) + a_N2[3]*(T**3.0) + a_N2[4]*(T**4.0))
        Cp_O2 = R*(a_O2[0] + a_O2[1]*T + a_O2[2]*(T**2.0) + a_O2[3]*(T**3.0) + a_O2[4]*(T**4.0))
        Cp_air=0.78*Cp_N2+0.21*Cp_O2
    else :
##        a_N2=[0.03298677E+02,0.14082404E-02,-0.03963222E-04,0.05641515E-07,-0.02444854E-10,-0.10208999E+04,0.03950372E+02]
##        a_O2=[3.78245636E+00,-2.99673416E-03,9.84730201E-06,-9.68129509E-09,3.24372837E-12,-1.06394356E+03,3.65767573E+00]
##        Cp_N2 = R*(a_N2[0] + a_N2[1]*T + a_N2[2]*(T**2.0) + a_N2[3]*(T**3.0) + a_N2[4]*(T**4.0))
##        Cp_O2 = R*(a_O2[0] + a_O2[1]*T + a_O2[2]*(T**2.0) + a_O2[3]*(T**3.0) + a_O2[4]*(T**4.0))
##        Cp_air=0.78*Cp_N2/M_N2+0.21*Cp_O2/M_O2
        return(cp_air(999))
    return(Cp_air)

def cp_H2(T) :
    if T<1000.0 :
        a_H2=[3.33727920E+00,-4.94024731E-05,4.99456778E-07,-1.79566394E-10,2.00255376E-14,-9.50158922E+02,-3.20502331E+00]
        Cp_H2 = R*(a_H2[0] + a_H2[1]*T + a_H2[2]*(T**2.0) + a_H2[3]*(T**3.0) + a_H2[4]*(T**4.0))
    else :
##      a_H2=[2.34433112E+00,7.98052075E-03,-1.94781510E-05,2.01572094E-08,-7.37611761E-12,-9.17935173E+02,6.83010238E-01]
##      Cp_H2 = R*(a_H2[0] + a_H2[1]*T + a_H2[2]*(T**2.0) + a_H2[3]*(T**3.0) + a_H2[4]*(T**4.0))
        return(cp_H2(999))
    return(Cp_H2)

def cp_H2O (T) :
    if T<1000.0 :
        a_H2O=[3.03399249E+00,2.17691804E-03,-1.64072518E-07,-9.70419870E-11,1.68200992E-14,-3.00042971E+04,4.96677010E+00]
        Cp_H2O = R*(a_H2O[0] + a_H2O[1]*T + a_H2O[2]*(T**2.0) + a_H2O[3]*(T**3.0) + a_H2O[4]*(T**4.0))
    else :
##      a_H2=[4.19864056E+00,-2.03643410E-03,6.52040211E-06,-5.48797062E-09,1.77197817E-12,-3.02937267E+04,-8.49032208E-01]
##      Cp_H2 = R*(a_H2[0] + a_H2[1]*T + a_H2[2]*(T**2.0) + a_H2[3]*(T**3.0) + a_H2[4]*(T**4.0))
        return(cp_H2O(999))
    return(Cp_H2O)

def cp_N2(T) :
    if T<1000.0 :
        a_N2=[0.02926640E+02,0.14879768E-02,-0.05684760E-05,0.10097038E-09,-0.06753351E-13,-0.09227977E+04,0.05980528E+02]
        Cp_N2 = R*(a_N2[0] + a_N2[1]*T + a_N2[2]*(T**2.0) + a_N2[3]*(T**3.0) + a_N2[4]*(T**4.0))
    else :
##        a_N2=[0.03298677E+02,0.14082404E-02,-0.03963222E-04,0.05641515E-07,-0.02444854E-10,-0.10208999E+04,0.03950372E+02]0]
##        Cp_N2 = R*(a_N2[0] + a_N2[1]*T + a_N2[2]*(T**2.0) + a_N2[3]*(T**3.0) + a_N2[4]*(T**4.0))
        return(cp_N2(999))
    return(Cp_N2)

def cp_O2(T) :
    if T<1000.0 :
        a_O2=[3.28253784E+00,1.48308754E-03,-7.57966669E-07,2.09470555E-10,-2.16717794E-14,-1.08845772E+03,5.45323129E+00]
        Cp_O2 = R*(a_O2[0] + a_O2[1]*T + a_O2[2]*(T**2.0) + a_O2[3]*(T**3.0) + a_O2[4]*(T**4.0))
    else :
##        a_O2=[3.78245636E+00,-2.99673416E-03,9.84730201E-06,-9.68129509E-09,3.24372837E-12,-1.06394356E+03,3.65767573E+00]
##        Cp_O2 = R*(a_O2[0] + a_O2[1]*T + a_O2[2]*(T**2.0) + a_O2[3]*(T**3.0) + a_O2[4]*(T**4.0))
        return(cp_O2(999))
    return(Cp_O2)

def T0(z):
    a=0.0065
    Ti=20.0
    res=Ti-(a*float(z))
    res=273.15+res
    if (res<3.0) :
        res=3.0
    
    return(res)
    


def Tt0 (M0,z) : 
    return(T0(z)*(1.0+(gamma-1.0)/2.0*M0*M0))

def P0 (z) :
    P0=Patm*((1.0-0.0065*z/T0(0))**5.255)
    return(P0)

def Pt0 (M0,z) :
##    Pt0=P0(z)*((1.0+(gamma-1.0)/2.0*M0*M0)**(gamma/(gamma-1.0)))
##    if Pt0 < 0.01 :
##        return (0.01)
##    else :
    return(P0(z)*((1.0+(gamma-1.0)/2.0*M0*M0)**(gamma/(gamma-1.0))))

def Pt1 (M0,z) :
    if M0<1.0 :
        Pt1=Pt0(M0,z)*0.95
    else :
        Pt1=Pt0(M0,z)*(0.95-0.075*((M0-1)**1.35))
    return (Pt1)

def Tt1 (M0,z) :
    
    return (Tt0(M0,z)*((Pt1(M0,z)/Pt0(M0,z))**((gamma-1.0)/gamma)))

def T1(M0,z):
    return (Tt1(M0,z)/(1.0+(gamma-1.0)/2.0*(M0**2.0)))



def T2 (M0,z,flux_1_5) :
    flux_sortie=Dn/M_air*cp_air(T1(M0,z))*float(T1(M0,z))-float(flux_1_5)
    
    a=3.0
    b=3500.0
    while abs(b-a)>0.01 :
        m=(a+b)/2.0
        
        if (Dn*cp_air(m)/M_air*m)>flux_sortie :
            b=m
        else :
            a=m
    return((a+b)/2.0)

def Tt2(M0,z,flux_1_5) :
    return (T2(M0,z,flux_1_5)*(1.0+(gamma-1.0)/2.0*(M0**2.0)))


def Pt2 (M0,z,flux_1_5) :
    return (Pt1(M0,z)*((Tt2(M0,z,flux_1_5)/Tt1(M0,z))**(gamma/(gamma-1.0))))


def CRS_to_CFR (CRS_0) :
    k=0
    while (k<len(CRS)-1) and (CRS[k]<CRS_0) :
            k+=1
    if k>=len(CRS)-1 :
        return (CFR1[len(CRS)-1])
    else :
        t=(CRS_0-CRS[k-1])/(CRS[k]-CRS[k-1])
        CFR_0=CFR1[k]*t+CFR1[k-1]*(1-t)
    return (CFR_0)
    
def CFR_to_RPR (CFR_0) :
    k=0
    while (k<len(RPR)-1) and (CFR2[k]<CFR_0)  :
        k+=1
    if k>=len(RPR)-1 :
        return (RPR[len(RPR)-1])
    else :
        t=(CFR_0-CFR2[k-1])/(CFR2[k]-CFR2[k-1])
        RPR_0=RPR[k]*t+RPR[k-1]*(1-t)
        return (RPR_0)

def theta2(M0,z,flux_1_5):
    return(Tt2(M0,z,flux_1_5)/Tn)

def delta2 (M0,z,flux_1_5) :
    return (Pt2(M0,z,flux_1_5)/Patm)

def CRS_0 (M0,z,flux_1_5) :
    return(100.0/((theta2(M0,z,flux_1_5))**0.5))

def RPR_0 (M0,z,flux_1_5) :
    RPR_0=CFR_to_RPR(CRS_to_CFR(CRS_0(M0,z,flux_1_5)))
    return(RPR_0)

def CFR_0(M0,z,flux_1_5):
    CFR_0=CRS_to_CFR (CRS_0(M0,z,flux_1_5))
    return (CFR_0)

def D_air (M0,z) :
    return (Dn*CFR_0(M0,z,flux_1_5)/100.0*delta2 (M0,z,flux_1_5)/(theta2(M0,z,flux_1_5)**(0.5)))

def PI (M0,z,flux_1_5) :
    return (PIn*RPR_0(M0,z,flux_1_5))

def Pt3(M0,z,flux_1_5) :
    return (Pt2(M0,z,flux_1_5)*PI(M0,z,flux_1_5))

def Tt3(M0,z,flux_1_5) :
    return (Tt2(M0,z,flux_1_5)*(PI(M0,z,flux_1_5)**((gamma-1.0)/gamma)))

def T3(M0,z,flux_1_5):
    return (Tt3(M0,z,flux_1_5))



def T_H2_i (D_H2,flux_3_4,flux_1_5) :
    a=20.0
    b=3500.0
    while abs(b-a)>0.01 :
        m=(a+b)/2
        if (m*cp_H2(m)*D_H2)>((flux_3_4+flux_1_5)*M_H2+T_H2_0*cp_H2(T_H2_0)*D_H2) :
            b=m
        else :
            a=m
    return(m)

def richesse_i (M0,z,T_H2,flux_1_5) :
    res=0.79*Zst*cp_N2(Tb)*Tb+0.5*cp_O2(Tb)*Tb-Zst*cp_air(T3(M0,z,flux_1_5))*T3(M0,z,flux_1_5)
    res=res/(cp_H2(T_H2)*T_H2-cp_H2O(Tb)*Tb+cp_O2(Tb)*Tb)
    if res<0.0 :
        return(0.0)
    elif res>1.0 :
        return(1.0)
    else :
        return(res)

def D_H2_i (M0,z,T_H2,flux_1_5) :
    return(richesse_i(M0,z,T_H2,flux_1_5)*D_air(M0,z)/34.3196)

def D_H2_f (M0,z,flux_3_4,flux_1_5) :
    nb_iterations_max=10
    nb_iterations=1
    D_H2_f1=2.0
    T_H2_f=T_H2_i (D_H2_f1,flux_3_4,flux_1_5)
    D_H2_f2=D_H2_i (M0,z,T_H2_f,flux_1_5)
    while abs (D_H2_f1-D_H2_f2)>0.01 and nb_iterations<nb_iterations_max :
        T_H2_f=T_H2_i (D_H2_f2,flux_3_4,flux_1_5)
        m=D_H2_i (M0,z,T_H2_f,flux_1_5)
        D_H2_f1=D_H2_f2
        D_H2_f2=m
        nb_iterations+=1
        
    return (D_H2_f2)

def T_H2_f(M0,z,flux_3_4) :
    return(T_H2_i (D_H2_f (M0,z,flux_3_4,flux_1_5),flux_3_4,flux_1_5))

def richesse_f (M0,z,flux_3_4,flux_1_5) :
    return(richesse_i (M0,z,T_H2_f(M0,z,flux_3_4),flux_1_5))
    
        



    
        
    

##def flux_massique_3_4(M0,D_H2,z): 
##    return ((((D_H2*cp_H2(Tb)+D_air(M0,z)*cp_air(Tb))*Tb)-(D_H2*cp_H2(T_H2)*T_H2)-(D_air(M0,z)*cp_air(T3(M0,z))*T3(M0,z)))/(D_H2+D_air(M0,z)))

def Pt4(M0,z,flux_1_5) :
    return (Pt3(M0,z,flux_1_5)*((Tb/T3(M0,z,flux_1_5))**(gamma/(gamma-1.0))))

def Tt4(M0,z,flux_1_5):
    return (Tt3(M0,z,flux_1_5)*((Pt4(M0,z,flux_1_5)/Pt3(M0,z,flux_1_5))**((gamma-1.0)/gamma)))


def T5(M0,z,richesse,flux_3_4) :
    
    flux_sortie=D_air(M0,z)*(richesse*cp_H2O(Tb)*Tb/M_H2O+0.79*Zst*cp_N2(Tb)/M_N2+(0.5-richesse/2.0)*cp_O2(Tb)*Tb/M_O2)-flux_3_4
    a=30.0
    b=3500.0
    while abs(b-a)>0.01 : 
        m=(a+b)/2.0
        if D_air(M0,z)*(richesse*cp_H2O(m)*m/M_H2O+0.79*Zst*cp_N2(m)/M_N2+(0.5-richesse/2.0)*cp_O2(m)/M_O2*m)>flux_sortie :
            b=m
        else :
            a=m
    return((a+b)/2.0)

def Pt5(M0,z,richesse,flux_1_5,flux_3_4) :    
    return (Pt4(M0,z,flux_1_5)*((T5(M0,z,richesse,flux_3_4)/Tb)**(gamma/(gamma-1.0))))

def M9 (M0,z,richesse,flux_1_5,flux_3_4) :
    
    res=Pt5(M0,z,richesse,flux_1_5,flux_3_4)/P0(z)
    res=res**((gamma-1.0)/gamma)
    
    res=2.0*(res-1.0)/(gamma-1.0)
    if res<0 : 
        res=res**0.5
    return(res)



def a0(z) :
    
    return((gamma*r*T0(z))**0.5)

def Fsp (M0,z,flux_1_5,flux_3_4) :
    richesse=richesse_f (M0,z,flux_3_4,flux_1_5)
    res=M9(M0,z,richesse,flux_1_5,flux_3_4)*(((Tt4(M0,z,flux_1_5)/T0(z))/(Tt3(M0,z,flux_1_5)/Tt2(M0,z,flux_1_5))/(Tt0(M0,z)/T0(z)))**0.5)
    res=a0(z)*(res-M0)
    return(res)

def f_D(M0,z) :
##    res=Tt4(M0,z)/T0(z)-Tt3(M0,z)/Tt2(M0,z)*Tt0(M0,z)/T0(z)
##    res=res*T0(z)
##    res=res*gamma*r/(gamma-1)
##    res=res/PCI
    res=D_H2_f (M0,z,flux_1_5)/D_air(M0,z)
    return(res)
    
def v9 (M0,z,flux_1_5,flux_3_4) :
    return((Fsp(M0,z,flux_1_5,flux_3_4)/a0(z)+M0)*a0(z))

def rendement_p(M0,z,flux_1_5,flux_3_4):
    return((2*M0)/(v9(M0,z,flux_1_5,flux_3_4)/a0(z)+M0))

def rendement_th(M0,z) :
    return (1.0-(1.0/(Tt3(M0,z)/Tt2(M0,z)*Tt0(M0,z)/T0(z))))

def rendement_global(M0,z) :
    return (rendement_p(M0,z,flux_1_5,flux_3_4)*rendement_th(M0,z))



dt=1.0
T=600.0
angle_gamma=5.0/360.0*2.0*np.pi
angle_alpha=5.0/360.0*2.0*np.pi
f=10.0
Cz=2.0*np.pi*angle_alpha
Cx=Cz/f
Masse_mol=28.976E-03
Rmax=7000.0
m_engin=200*1000

def masse_vol(z) :
    return (P0(z)*100000.0*Masse_mol/(R*T0(z)))

##def f_D_H2_liste() :
##    res=[5.079757924990806, 3.4439249267509324, 4.627407415869854, 3.6270447089040023, 5.345608344548617, 4.590320145809195, 3.720877827086815, 5.052320095934976, 4.924990562886784, 5.26828207514362, 3.0903867865027137, 5.650486686809412, 4.35580587098802, 4.72269458270498, 5.461034246072856, 6.45997448327687, 4.772007457183339, 4.293964407594086, 5.998292312772231, 5.288378283105735, 5.842182706394764, 6.198230265386472, 5.079804140617952, 4.3418372017214075, 4.693349229980932, 4.883524271088158, 3.8566735419265905, 5.493153997723581, 4.985683783228067, 5.729789652313322, 3.7255833612660587, 6.53466338824787, 4.177150534294047, 3.024696103387165, 4.522717412554453, 5.586492180618443, 4.414192294951765, 5.852972895466067, 5.378253727034524, 4.3235161761401475, 6.630699085394891, 3.915917799878434, 5.4639293482280715, 2.211757994402352, 5.807125940056652, 3.1987871738100484, 4.714791414542762, 4.858526469981007, 3.873001378378986, 6.084581464422847, 6.812173136220559, 4.5289996493999265, 5.246282343140927, 5.856541686826802, 4.380217387580813, 3.080558642606637, 5.083706961566244, 5.591106539382059, 3.5508581958461214, 4.845461710911339, 4.951087178328395, 6.5162049858669135, 4.593190785783858, 4.6652196933692665, 5.871844902363143, 6.763769099503352, 3.887855236078699, 4.844808521619521, 4.057102348043048, 3.6905610877336104, 5.2128653202343544, 4.741849353695395, 4.7145992484238075, 4.20123986335508, 4.5941063876155726, 5.009611109331353, 6.271795080751174, 3.6156166834704844, 5.4275208760011875, 4.842507176696004, 4.077460704559438, 4.312944683487054, 5.308409197599086, 5.099081070641648, 4.960827669834816, 6.301196548698813, 6.860923199783829, 5.3768174681598815, 7.346086780362146, 5.593646609797439, 3.9118588770586276, 7.6631319012079295, 5.700756866405781, 2.5205008061326573, 4.401255587634667, 4.178816102413441, 4.015448403001605, 3.621190159248661, 4.402309648580546, 3.3477840338767293, 4.085773061051636, 4.502893605678501, 5.189498954739222, 7.913544754528506, 5.121609817762257, 6.113629949226604, 5.78335818552381, 6.118342801034071, 3.9800813232848977, 4.321274345928126, 4.644816295526045, 5.04845316104818, 4.646240262547824, 3.4640812004935935, 3.110582453597328, 4.742497294045158, 5.261997234782694, 4.59786127036323, 2.530584220176466, 4.371971944542664, 4.445732997715213, 4.916925675824542, 4.438479345825736, 4.29319498469076, 1.2621490434817735, 4.549363026109732, 2.4279259234022508, 6.746792567971756, 3.6346825881094214, 3.4371169397709687, 5.634540021137806, 7.015442695741648, 6.686914462968251, 2.3224104160343164, 3.762994704613079, 4.506396272076214, 6.99049081842618, 4.420022926313135, 3.681013421059191, 3.5972520419239054, 3.6217056391563465, 6.3242261064056535, 4.30357482509061, 3.482430546754155, 4.412849662566431, 6.948775318963309, 5.683574796370409, 2.8384252957797913, 3.8871569278931504, 6.223703952925668, 3.482844527135717, 6.485816554040036, 5.203201495242274, 4.0432110069396385, 3.626450886768741, 5.467317805509356, 4.085496791184862, 5.993424296816602, 4.237449417018543, 3.0891474910395664, 3.6482678178155497, 5.895249615024247, 5.7250665203243685, 5.5090058889802735, 5.170726047291012, 4.797960592713965, 5.124582051264027, 5.111290123221694, 5.75118867371472, 6.190003056596769, 5.7691814308346, 4.7933449561984744, 3.62320560925916, 5.440185968732014, 4.035677622149491, 5.732334631979308, 5.317688514506311, 4.507761093562979, 5.663610033539996, 5.13023667105851, 5.102183000624526, 3.8345277260212667, 6.47403818159632, 4.960265820734472, 6.680186992344385, 6.352775600997151, 4.800272080471815, 6.278640824084287, 3.274772387256633, 4.661792386651992, 5.082567851297636, 4.760595563017512, 5.725706752830507, 5.746342157658725, 4.741156464920373, 4.162023053890462, 4.714296827178407, 4.597118264868805, 3.845454610063864, 5.4831454431747435, 4.066926327604942, 5.327288191967817, 3.9708609920923137, 5.23381939829251, 6.777453687338132, 5.095658886755913, 6.2135561455084325, 5.764649638814371, 2.942322635504095, 3.673721397332362, 3.9631644248824656, 6.126229065614258, 5.128302275433243, 4.653312668365704, 4.193171898173072, 5.818257124286274, 3.3988073246524033, 4.344191300271162, 6.450676064035276, 5.820610828779374, 4.678389579698757, 4.2612185085987235, 4.9641663113904455, 3.886546508142296, 4.024422832209589, 5.654647358053121, 2.1149759301116484, 4.027137645886799, 4.3029224504937345, 5.884398693103671, 5.575423836514064, 4.804376297722252, 6.341476296670112, 4.981751940922574, 4.278713152410513, 4.39492878353798, 6.816711739323147, 4.888957033424619, 5.954810646753869, 4.42791490096618, 4.732972920764064, 5.282827113911488, 6.16470062408641, 5.255451210256112, 2.8383869411811404, 5.134611358719935, 4.464142003517437, 7.135113741729387, 5.563481405397365, 5.117419064203383, 4.917270407276568, 5.601054501353163, 4.97838547036399, 5.42584255134691, 3.1238060144590896, 4.83059161013019, 5.035400546320053, 5.689094650952352, 3.181310085717915, 4.398114327698884, 5.559926325315608, 6.057489991455608, 4.772693607759201, 4.016633584013216, 4.532944098005909, 3.484608271697491, 4.358720644089409, 6.044609106368124, 5.848385584222091, 4.568321003672644, 4.471142765577655, 4.410432835749536, 5.281917693469375, 4.176706537236401, 5.905352295904492, 3.8031574699022723, 5.5361282788062, 3.9005182330685146, 7.293976034685663, 4.353391405908987, 4.2973997511303015, 5.80383265130422, 5.021727202341866, 7.40023704996979, 5.39598245388633, 3.885022993703296, 5.029970356406761, 3.8103528647398885, 5.260312119980396, 4.3877902133132896, 6.651759142905572, 4.760847908885774, 5.053307621528005, 4.481078018569054, 4.5801626057696545, 4.07008725378564, 3.612260735743141, 6.930816916516234, 2.0027001791642762, 3.3611326906370005, 6.126335320940922, 4.238444800707936, 4.395951017174701, 5.0220938589586686, 5.620122025075732, 4.8564669292186915, 4.873100878500869, 4.083124026159788, 5.035992977783756, 4.740222744913107, 3.5682131531086285, 5.964164858074632, 6.455566121609254, 5.703602388710218, 4.588125242188652, 3.976323451200179, 2.573938617188696, 5.1004699157031235, 5.398161145200214, 5.151817597986025, 3.034284103714504, 2.4596512730298246, 4.82404637762694, 3.914282482018044, 7.5905147436790035, 4.6034833973790175, 4.174646751875222, 7.758874732345599, 5.0461219049992145, 4.153902419191175, 6.3336990868395375, 3.946287982388214, 2.9830334500223414, 4.2461675410823885, 4.423663695674938, 6.147748206775594, 3.6061454457286692, 4.584841010260301, 4.26424522592754, 4.620051037485806, 4.742578735033097, 5.114432932823702, 6.221981207708231, 4.458087554779857, 4.1896460912631275, 4.292228682577777, 6.576381049047371, 4.122032985540696, 5.0724031577304975, 5.614854977071723, 5.27458606546273, 4.182040362680345, 4.505229524470096, 5.143404835566186, 4.339318017367584, 3.671417857061421, 4.313890898800065, 6.113649241908779, 4.689466852892462, 5.3813174491662625, 4.944474758023995, 3.8216592158905702, 3.128113749375643, 3.7801448409314533, 4.9399497835606505, 5.502940766592967, 5.556073226560475, 4.712098141254712, 6.1514911722281145, 6.397492784662793, 7.31490383202567, 5.986312676710057, 4.98179480453647, 4.324224369692312, 4.089750291790623, 8.019969468432489, 4.835403849828931, 5.557130787750803, 6.791017605052633, 4.1064973613934175, 2.8105053437611045, 5.199323852806487, 4.821660928549688, 5.442514151095406, 5.746009826593771, 5.26945086767842, 4.552029347274411, 5.415955009495384, 6.291335445837246, 3.4020707624669417, 5.016606836644411, 5.009319316144364, 5.791178676119682, 4.580206022220805, 3.930805828539788, 5.172948015534871, 4.314280329874137, 4.882516482961968, 6.077743664125959, 3.9531707227668536, 3.243459999230799, 6.232896293796422, 4.3338731350152955, 5.7149029354061724, 5.6671632456531515, 5.435679551448434, 4.480140001966209, 5.243356757811512, 5.128021577151293, 5.1061992701306185, 4.251702188083774, 7.529736175884488, 4.645062686639105, 4.266149357302578, 4.102101797864921, 5.212606749230736, 4.996052979888734, 4.143775953861469, 5.110466631642148, 4.3991815108053975, 4.821924551376663, 3.861471905159827, 4.369630772094922, 6.097485547457555, 4.567907017669508, 4.326665804273944, 3.6566566887705956, 4.476969032789017, 4.616246271031053, 4.018332100839197, 3.9800289168625946, 5.465422797251761, 5.379338408828746, 4.347341342398472, 5.672602679277748, 5.063959789381573, 4.628082757415276, 5.799356114168638, 4.634014574546441, 5.486334489540065, 3.6242989938811845, 4.947323790308976, 6.230573458908786, 6.128347914192777, 3.9146233367056613, 3.65542319100319, 5.344654694349461, 4.101330149985035, 5.999262951602485, 5.731082088779876, 5.870095284885774, 4.838891521097684, 5.844916370103016, 5.430114645622733, 4.521398189209187, 3.2832986414324483, 3.499115908019546, 5.746350064880233, 3.9967248859583155, 5.39731953488061, 4.508254757689057, 4.169275310212681, 3.897030106798717, 6.596698128661529, 4.55468727160424, 3.8790050627603, 5.595790700956938, 3.442276262544989, 0.6424634854338133, 6.348986606137614, 3.7769834953161205, 4.960891685910304, 5.246181748973914, 7.701570900398743, 5.301904468672719, 3.5173324627256553, 4.306643961600405, 4.810624112375347, 4.731651031173349, 4.206503082864007, 6.794689531851858, 5.041286387261387, 6.007401009654927, 5.475651573662739, 6.24074125142981, 5.1960617506761695, 5.32441512836651, 4.886551171227186, 6.225253008447823, 5.519379985425775, 4.33311121712134, 4.3668006076179555, 5.568668453608204, 5.330765069635032, 6.3989253659160745, 3.3570223632816996, 6.663728610864866, 6.386848263106481, 4.603824972845431, 5.425558254490306, 3.5962917008120336, 4.771335187819635, 4.451013554832576, 5.5051760632224225, 5.0755088000074435, 5.463936925459513, 3.9473228441107313, 5.234490238635287, 6.513484419062805, 6.384344918786322, 6.005063550482033, 6.663757659546646, 4.382075856881631, 5.680193477557168, 6.133580258752115, 4.645057712064173, 4.899987475490464, 5.551685147666785, 5.077236780134098, 5.800335137590297, 5.546724119276722, 4.742396313574768, 4.7620710314812404, 4.384144726701437, 3.4471112658546494, 3.8155184569266467, 3.50611679710761, 6.368396348464805, 4.398186917538269, 4.663968324940466, 3.8916458877484863, 4.797994460012528, 4.948289162453571, 5.816303246069705, 5.267008935850557, 4.415686099870474, 3.988162496063213, 5.0747197122133265, 4.363955645946841, 4.2651974372169486, 3.993529752979408, 3.6987829490628594, 4.990320198271916, 3.987688484709538, 4.5590501609615455, 5.049186214044659, 4.650070097302544, 4.365603361374145, 4.801627442903423, 3.4411503058687862, 5.304478993546583, 1.485659208079545, 6.485004254253458, 5.320976929701052, 4.076569573360693, 5.986344093273401, 6.754005130403927, 4.909374321277943, 3.850604254291351, 5.890487622067614, 4.1434682237303235, 4.560419766502121, 5.416127968581929, 4.781706455700207, 5.981534149200011, 5.0163111055521385, 4.527856631576601, 4.870887726959981, 4.450952728173337, 3.8326923629833107, 5.85537226456576, 6.3738078279061625, 4.120716087037569, 5.140063921121154, 4.465358696348239, 3.2229562783599763, 4.085062420056511, 3.6863119532600352, 4.446257541965857, 3.983745440831458, 4.273588002271992, 5.612071082553449, 5.59981928278975, 3.9110351262753915, 5.754366264214873, 5.119899970832586, 5.7272140560134, 3.448412025329767, 5.931033682814717, 5.2760220143549885, 6.075379178217431, 5.663742813780832, 3.9161048338459206, 4.4416125576126735, 5.74534634916372, 3.6983572652737347, 3.6829962909863476, 4.7261696767403105, 6.716577398632982, 4.9995394387303795, 4.430905899877789, 4.211867689962261]
##
##    return (res)


def f_x_z_liste(flux_1_5,flux_3_4):
    x=[0.0,0.0]
    z=[0.0,0.0]
    M=[0.0,0.0]
    t=[0.0,0.0]
    D_H2=[0.0,0.0]
    for i in  range (int(T/dt)):
       
        t.append(float(i+1)*dt)
        V0=((((x[i+1]-x[i])/dt)**2.0)+(((z[i+1]-z[i])/dt)**2.0))**0.5
        
        M.append(V0/((gamma*R/Masse_mol*T0(z[i+1]))**0.5))
        D_H2.append(D_H2_f(M[i+1],z[i+1],flux_3_4,flux_1_5))
        Fsp0=Fsp(M[i+1],z[i+1],flux_1_5,flux_3_4)
        x.append((dt**2.0)*(-1.0*g*np.sin(angle_alpha)-0.5*Cx*masse_vol(z[i+1])*g/Rmax*(V0**2.0)+Fsp0*np.cos(angle_alpha)*(D_air(M[i+1],z[i+1])+D_H2[i+1])/m_engin)-x[i]+2*x[i+1])
        z.append((dt**2.0)*(-1.0*g*np.cos(angle_alpha)+0.5*Cz*masse_vol(z[i+1])*g/Rmax*(V0**2.0)+Fsp0*np.sin(angle_alpha)*(D_air(M[i+1],z[i+1])+D_H2[i+1])/m_engin)-z[i]+2*z[i+1])
        if M[i+2]>7.5 :
            M[i+2]=7.5
            Fsp0=Fsp(M[i+1],z[i+1],flux_1_5,flux_3_4)
            x[i+2]=(dt**2.0)*(-1.0*g*np.sin(angle_alpha)-0.5*Cx*masse_vol(z[i+1])*g/Rmax*(V0**2.0)+Fsp0*np.cos(angle_alpha)*(D_air(M[i+1],z[i+1])+D_H2[i+1])/m_engin)-x[i]+2*x[i+1]
            z[i+2]=(dt**2.0)*(-1.0*g*np.cos(angle_alpha)+0.5*Cz*masse_vol(z[i+1])*g/Rmax*(V0**2.0)+Fsp0*np.sin(angle_alpha)*(D_air(M[i+1],z[i+1])+D_H2[i+1])/m_engin)-z[i]+2*z[i+1]  
        if z[i+2]>40000.0 :
            z[i+2]=40000.0
            V0=((((x[i+1]-x[i])/dt)**2.0)+(((z[i+2]-z[i+1])/dt)**2.0))**0.5
            M[i+2]=V0/((gamma*R/Masse_mol*T0(z[i+1]))**0.5)
            if M[i+2]>7.5 :
                M[i+2]=7.5
        elif z[i+2]<0.0 :
            z[i+2]=0.0
            V0=((((x[i+1]-x[i])/dt)**2.0)+(((z[i+2]-z[i+1])/dt)**2.0))**0.5
            M[i+2]=V0/((gamma*R/Masse_mol*T0(z[i+1]))**0.5)
    return(x,z,M,D_H2,t)


##delta_variation_D_H2=0.01
##
##def variation_de_liste_D_H2(D_H2_liste,nombre_de_variations):
##    res=[]
##    for k in range (0,len(D_H2_liste)):
##        res.append(D_H2_liste[k]+((random.random()-0.5)*2.0*delta_variation_D_H2*float(nombre_de_variations+1)))
##        if res[k]<=0 :
##           res[k]=0.01
##    return(res)
##
##nombre_de_variations_max=500
##nombre_de_changements_de_liste_max=500
##
##
##def optimization_D_H2_liste () :
##    D_H2_liste1=f_D_H2_liste()
##    res1=f_x_z_liste(D_H2_liste1)
##    z_liste1=res1[1]
##    M0_liste1=res1[2]
##    z_f1=z_liste1[-1]
##    M0_f1=M0_liste1[-1]
##    nombre_de_variations=0
##    nombre_de_changements_de_liste=0
##    while (nombre_de_variations_max>nombre_de_variations) and (nombre_de_changements_de_liste_max>nombre_de_changements_de_liste) :
##        D_H2_liste2=D_H2_liste1
##        D_H2_liste2=variation_de_liste_D_H2(D_H2_liste2,nombre_de_variations)
##        res2=f_x_z_liste(D_H2_liste2)
##        z_liste2=res2[1]
##        M0_liste2=res2[2]
##        z_f2=z_liste2[-1]
##        M0_f2=M0_liste2[-1]
##        if ((abs(z_f1-27000.0))>(abs(z_f2-27000.0))) and ((abs(z_f1-27000.0))<=100.0) :
##            if ((abs(M0_f1-6.0))>(abs(M0_f2-6.0))) and ((abs(M0_f1-6.0))<=0.1) :
##                if ((sum(D_H2_liste1))<(sum(D_H2_liste2))) :
##                    D_H2_liste1=D_H2_liste2
##                    z_f1=z_f2
##                    M0_f1=M0_f2
##                    nombre_de_changements_de_liste+=1
##                    nombre_de_variations=0
##                else :
##                    nombre_de_variations+=1
##            elif ((abs(M0_f1-6.0))>(abs(M0_f2-6.0))) and ((abs(M0_f1-6.0))>0.1) :
##                D_H2_liste1=D_H2_liste2
##                z_f1=z_f2
##                M0_f1=M0_f2
##                nombre_de_changements_de_liste+=1
##                nombre_de_variations=0
##            else :
##                nombre_de_variations+=1
##        elif ((abs(z_f1-27000.0))>(abs(z_f2-27000.0))) and ((abs(z_f1-27000.0))>100.0) :
##            D_H2_liste1=D_H2_liste2
##            z_f1=z_f2
##            M0_f1=M0_f2
##            nombre_de_changements_de_liste+=1
##            nombre_de_variations=0
##        else :
##            nombre_de_variations+=1
##        print("nombre_de_variations :",nombre_de_variations)
##        print("nombre_de_changements_de_liste :",nombre_de_changements_de_liste)
##    return(D_H2_liste1)
##        


delta_variation_flux=10000

def variation_flux (flux_1_5,flux_3_4,nb_variations):
    res_1_5=flux_1_5+(random.random()-0.5)*2.0*(nb_variations+1)*delta_variation_flux
    res_3_4=flux_3_4+(random.random()-0.5)*2.0*(nb_variations+1)*delta_variation_flux
    if res_3_4<0.0 :
        res_3_4=0.0
    if res_1_5<0.0 :
        res_1_5=0.0
    res=[res_1_5,res_3_4]
    return(res)

def optimisation_flux () :
    flux_1_5=50000.0
    flux_3_4=50000.0
    nombre_de_variations_max=50
    nombre_de_changements_de_liste_max=200
    nombre_de_variations=0
    nombre_de_changements_de_liste=0
    D_H2_sum_1=sum(f_x_z_liste(flux_1_5,flux_3_4)[3])
    while (nombre_de_variations_max>nombre_de_variations) and (nombre_de_changements_de_liste_max>nombre_de_changements_de_liste) :
        res=variation_flux (flux_1_5,flux_3_4,nombre_de_variations)
        res_1_5=res[0]
        res_3_4=res[1]
        D_H2_sum_2=sum(f_x_z_liste(res_1_5,res_3_4)[3])
        if D_H2_sum_2<D_H2_sum_1 :
            flux_1_5=res_1_5
            flux_3_4=res_3_4
            D_H2_sum_1=D_H2_sum_2
            nombre_de_changements_de_liste+=1
            nombre_de_variations=0
        else :
            nombre_de_variations+=1
        print("nombre_de_variations :",nombre_de_variations)
        print("nombre_de_changements_de_liste :",nombre_de_changements_de_liste)
        print(D_H2_sum_1)
        print(flux_1_5)
        print(flux_3_4)
    res=[flux_1_5,flux_3_4]
    return(res)
            
    

##D_H2_liste=optimization_D_H2_liste ()

flux_1_5_f=optimisation_flux ()[0]
flux_3_4_f=optimisation_flux ()[1]
#flux_1_5_f=0.0
#flux_3_4_f=0.0
resultat=f_x_z_liste(flux_1_5_f,flux_3_4_f)
x_liste=resultat[0]
z_liste=resultat[1]
M0_liste=resultat[2]
D_H2_liste=resultat[3]
t_liste=resultat[4]
##print(D_H2_liste)
plt.subplot(221)
plt.plot(t_liste,x_liste)
plt.subplot(222)
plt.plot(t_liste,z_liste)
plt.subplot(223)
plt.plot(t_liste,M0_liste)
plt.subplot(224)
plt.plot(t_liste,D_H2_liste)
plt.show()
